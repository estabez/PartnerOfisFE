{"ast":null,"code":"/*\r\n* Authentication Manage Module\r\n*\r\n*/\nimport RestApiModule from './RestApiModule';\nimport CryptoModule from './CryptoModule';\nimport store from './redux/store';\nimport { setToken, setAuthUser, setRegions, setSelectedRegion, setRadioSites } from './redux/actions';\n\nclass AuthModule {\n  constructor() {\n    this.store = store;\n    this.restApi = new RestApiModule();\n    this.crypto = new CryptoModule();\n    this.roleDefinitions = [];\n  }\n\n  login(u, p) {\n    return new Promise((res, rej) => {\n      this.restApi.callApi('login', {\n        username: this.crypto.encrypt(u),\n        password: this.crypto.encrypt(p)\n      }).then(async response => {\n        const {\n          token\n        } = response;\n        console.log(\"login\");\n        await this.registerUser(token, u).then(r => res(r));\n      }).catch(err => {\n        rej({\n          loginError: true,\n          err: err\n        });\n      });\n    });\n  }\n\n  constructRoleDefinitions(token) {\n    return new Promise((res, rej) => {\n      this.restApi.callApi('getConfig', {\n        token\n      }).then(response => {\n        this.roleDefinitions = JSON.parse(response.configurations.roleDefinitions);\n        res(true);\n      });\n    });\n  }\n\n  registerUser(token, u) {\n    return new Promise(async (res, rej) => {\n      await this.constructRoleDefinitions(token);\n      await this.userRegions(token).then(async regions => {\n        this.store.dispatch(setRegions(regions));\n        this.store.dispatch(setSelectedRegion(regions[0])); // Set radio site list for default region\n\n        await this.defaultRadioSiteList(token, regions[0]);\n      }).catch(empty => {\n        this.store.dispatch(setRegions(empty));\n        this.store.dispatch(setSelectedRegion(null));\n      });\n      this.roleDef(token).then(role => {\n        const user = {\n          name: u,\n          role\n        };\n        this.store.dispatch(setToken(token));\n        this.store.dispatch(setAuthUser(user));\n        res(true);\n      }).catch(() => {\n        rej(true);\n      });\n    });\n  }\n\n  userRegions(token) {\n    // this method changed to get all picklist in db\n    // In prev version we got only user's regions\n    return new Promise((res, rej) => {\n      this.restApi.callApi('getPickList', {\n        pickListName: \"regionPicklist\",\n        token\n      }).then(response => {\n        const regions = response.pickList.map(item => {\n          return item.regionPicklist_value;\n        });\n        res(regions.sort());\n      }).catch(err => {\n        rej([]);\n      });\n    });\n  }\n\n  defaultRadioSiteList(token, region) {\n    // It'll set radio site list for default region for user.\n    // Radio site list will change once region changed\n    return new Promise((res, rej) => {\n      this.restApi.callApi('getRadioListByRegion', {\n        region,\n        token\n      }).then(async response => {\n        const list = await response.List.map(item => {\n          return item.value;\n        });\n        this.store.dispatch(setRadioSites(list.sort()));\n        res(true);\n      }).catch(err => {\n        //this.store.dispatch(setRadioSites([]));\n        rej(false);\n      });\n    });\n  }\n\n  getRole(role) {\n    if (this.roleDefinitions) {\n      return this.roleDefinitions.find(item => {\n        return item.roleName === role;\n      });\n    }\n  }\n\n  roleDef(token) {\n    return new Promise((res, rej) => {\n      this.restApi.callApi('getRoles', {\n        token\n      }).then(response => {\n        let roleDefinition = {\n          mainPage: '',\n          permittedColumns: [],\n          permittedPages: []\n        };\n\n        if (response) {\n          //console.log(response)\n          response.roles.map(item => {\n            const {\n              mainPage,\n              permittedColumns,\n              permittedPages\n            } = this.getRole(item.role);\n\n            if (permittedColumns !== null && typeof permittedColumns === 'object') {\n              permittedColumns.map(col => {\n                if (!roleDefinition.permittedColumns.includes(col)) roleDefinition.permittedColumns.push(col);\n              });\n            }\n\n            if (permittedPages !== null && typeof permittedPages === 'object') {\n              permittedPages.map(col => {\n                if (!roleDefinition.permittedPages.includes(col)) roleDefinition.permittedPages.push(col);\n              });\n            }\n\n            if (roleDefinition.mainPage === '') {\n              roleDefinition.mainPage = mainPage;\n            }\n          });\n        }\n\n        res(roleDefinition);\n      }).catch(e => rej(e));\n    });\n  }\n\n}\n\nexport default AuthModule;","map":{"version":3,"sources":["C:/Users/ezerdon/Desktop/SSCM/ss/src/src/AuthModule.js"],"names":["RestApiModule","CryptoModule","store","setToken","setAuthUser","setRegions","setSelectedRegion","setRadioSites","AuthModule","constructor","restApi","crypto","roleDefinitions","login","u","p","Promise","res","rej","callApi","username","encrypt","password","then","response","token","console","log","registerUser","r","catch","err","loginError","constructRoleDefinitions","JSON","parse","configurations","userRegions","regions","dispatch","defaultRadioSiteList","empty","roleDef","role","user","name","pickListName","pickList","map","item","regionPicklist_value","sort","region","list","List","value","getRole","find","roleName","roleDefinition","mainPage","permittedColumns","permittedPages","roles","col","includes","push","e"],"mappings":"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","sourcesContent":["/*\r\n* Authentication Manage Module\r\n*\r\n*/\r\n\r\nimport RestApiModule from './RestApiModule'\r\nimport CryptoModule from './CryptoModule'\r\n\r\nimport store from './redux/store'\r\nimport {setToken, setAuthUser, setRegions, setSelectedRegion, setRadioSites} from './redux/actions'\r\n\r\nclass AuthModule {\r\n\r\n    constructor() {\r\n        this.store = store;\r\n        this.restApi = new RestApiModule();\r\n        this.crypto = new CryptoModule();\r\n\r\n        this.roleDefinitions = [];\r\n    }\r\n\r\n    login(u, p) {\r\n\r\n        return new Promise((res, rej) => {\r\n\r\n            this.restApi.callApi('login', {\r\n\r\n                username: this.crypto.encrypt(u),\r\n                password: this.crypto.encrypt(p)\r\n\r\n            }).then(async (response) => {\r\n\r\n                const {token} = response;\r\n                console.log(\"login\")\r\n                await this.registerUser(token, u).then(r => res(r));\r\n\r\n            }).catch((err) => {\r\n                rej({\r\n                    loginError: true,\r\n                    err: err\r\n                })\r\n            })\r\n        })\r\n    }\r\n\r\n    constructRoleDefinitions(token) {\r\n\r\n        return new Promise((res, rej) => {\r\n\r\n            this.restApi.callApi('getConfig', {\r\n                token\r\n            }).then(response => {\r\n                this.roleDefinitions = JSON.parse(response.configurations.roleDefinitions);\r\n                res(true)\r\n            })\r\n        })\r\n    }\r\n\r\n    registerUser(token, u) {\r\n\r\n        return new Promise (async (res, rej) => {\r\n\r\n            await this.constructRoleDefinitions(token);\r\n\r\n            await this.userRegions(token).then(async (regions) => {\r\n\r\n                this.store.dispatch(setRegions(regions));\r\n                this.store.dispatch(setSelectedRegion(regions[0]));\r\n\r\n                // Set radio site list for default region\r\n                await this.defaultRadioSiteList(token, regions[0]);\r\n\r\n            }).catch((empty) => {\r\n                this.store.dispatch(setRegions(empty));\r\n                this.store.dispatch(setSelectedRegion(null));\r\n\r\n            });\r\n\r\n            this.roleDef(token).then(role => {\r\n\r\n                const user = {\r\n                    name: u,\r\n                    role\r\n                };\r\n\r\n                this.store.dispatch(setToken(token));\r\n                this.store.dispatch(setAuthUser(user));\r\n                res(true);\r\n            }).catch(() =>{\r\n                rej(true)\r\n            })\r\n        })\r\n    }\r\n\r\n    userRegions(token) {\r\n        // this method changed to get all picklist in db\r\n        // In prev version we got only user's regions\r\n\r\n        return new Promise((res, rej) => {\r\n\r\n            this.restApi.callApi('getPickList', {\r\n                pickListName: \"regionPicklist\",\r\n                token\r\n            }).then((response) => {\r\n\r\n                const regions = response.pickList.map((item) => {\r\n                    return item.regionPicklist_value;\r\n                });\r\n\r\n                res(regions.sort());\r\n            }).catch(err => {\r\n                rej([])\r\n            })\r\n        });\r\n    }\r\n\r\n    defaultRadioSiteList(token, region) {\r\n        // It'll set radio site list for default region for user.\r\n        // Radio site list will change once region changed\r\n\r\n        return new Promise((res, rej) => {\r\n\r\n            this.restApi.callApi('getRadioListByRegion', {\r\n                region,\r\n                token\r\n            }).then(async (response) => {\r\n\r\n                const list = await response.List.map((item) => {\r\n                    return item.value;\r\n                });\r\n\r\n\r\n                this.store.dispatch(setRadioSites(list.sort()));\r\n\r\n                res(true);\r\n            }).catch(err => {\r\n                //this.store.dispatch(setRadioSites([]));\r\n\r\n                rej(false)\r\n            })\r\n        });\r\n    }\r\n\r\n    getRole(role) {\r\n        if (this.roleDefinitions) {\r\n            return this.roleDefinitions.find((item) => {\r\n                return (item.roleName === role)\r\n            })\r\n        }\r\n    }\r\n\r\n    roleDef(token) {\r\n\r\n        return new Promise((res, rej) => {\r\n\r\n            this.restApi.callApi('getRoles', {\r\n                token\r\n            }).then((response) => {\r\n\r\n                let roleDefinition = {\r\n                    mainPage: '',\r\n                    permittedColumns: [],\r\n                    permittedPages: []\r\n                }\r\n\r\n                if (response) {\r\n                    //console.log(response)\r\n                    response.roles.map(item => {\r\n\r\n                        const {mainPage, permittedColumns, permittedPages} = this.getRole(item.role);\r\n\r\n                        if (permittedColumns !== null && typeof permittedColumns === 'object') {\r\n                            permittedColumns.map(col => {\r\n                                if (!roleDefinition.permittedColumns.includes(col))\r\n                                    roleDefinition.permittedColumns.push(col);\r\n                            })\r\n                        }\r\n\r\n                        if (permittedPages !== null && typeof permittedPages === 'object') {\r\n                            permittedPages.map(col => {\r\n                                if (!roleDefinition.permittedPages.includes(col))\r\n                                    roleDefinition.permittedPages.push(col);\r\n                            })\r\n                        }\r\n\r\n                        if (roleDefinition.mainPage === '') {\r\n                            roleDefinition.mainPage = mainPage;\r\n                        }\r\n                    })\r\n                }\r\n                res(roleDefinition);\r\n\r\n            }).catch(e => rej(e));\r\n        })\r\n    }\r\n}\r\n\r\nexport default AuthModule;"]},"metadata":{},"sourceType":"module"}